(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{444:function(t,s,n){t.exports=n.p+"assets/img/1.aa355cb4.png"},445:function(t,s,n){t.exports=n.p+"assets/img/2.17d40553.png"},446:function(t,s,n){t.exports=n.p+"assets/img/3.1425bcde.png"},539:function(t,s,n){"use strict";n.r(s);var a=n(18),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"基本觀念釐清"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基本觀念釐清"}},[t._v("#")]),t._v(" 基本觀念釐清")]),t._v(" "),a("p",[t._v("儲存設備大致分為長期、短期兩種:")]),t._v(" "),a("ul",[a("li",[t._v("長期儲存設備：電腦的硬碟、手機的儲存硬體等")]),t._v(" "),a("li",[t._v("短期儲存設備：一般來說就是記憶體")])]),t._v(" "),a("p",[a("strong",[t._v("長期儲存設備")]),t._v(" 的反應"),a("strong",[t._v("很慢")]),t._v("，一般來說會盡量減少相關的存取次數")]),t._v(" "),a("p",[a("strong",[t._v("短期儲存設備")]),t._v(" 的反應"),a("strong",[t._v("相當快速")]),t._v("，不過"),a("strong",[t._v("記憶體")]),t._v("是所有硬體共享的區塊，有一套管理機制(負責記憶體分配與回收)來分配每個軟硬體的使用範圍(這一部份"),a("strong",[t._v("Unity")]),t._v("都已經幫我們完成了管理)")]),t._v(" "),a("p",[a("strong",[t._v("Unity")]),t._v("的記憶體是通過垃圾回收演算法 "),a("strong",[t._v("Boehm GC(Boehm Garbage Collection)")]),t._v(" 來管理的，其 "),a("strong",[t._v("不分代(Non-generational)")]),t._v(" 和 "),a("strong",[t._v("非壓縮式(Non-compacting)")]),t._v(" 的特性，導致了我們平常要注意避免載入過多的小記憶體，從而 "),a("strong",[t._v("記憶體碎片化(Memory fragmentation)")]),t._v("。")]),t._v(" "),a("ul",[a("li",[t._v("分代: 大塊記憶體、小記憶體、超小記憶體是分在不同記憶體區域來進行管理。還有長久記憶體，當有一個記憶體很久沒動的時候會移到長久記憶體區域中，從而省出記憶體給更頻繁分配的記憶體\n"),a("img",{attrs:{src:n(444),alt:""}}),t._v(" "),a("img",{attrs:{src:n(445),alt:""}})]),t._v(" "),a("li",[t._v("壓縮:當有記憶體被回收的時候，壓縮記憶體會把下圖空的地方重新排布\n"),a("img",{attrs:{src:n(446),alt:""}})]),t._v(" "),a("li",[t._v("非壓縮式會造成"),a("strong",[t._v("記憶體碎片化")]),t._v("：記憶體過多小記憶體，導致大記憶體不能有效地被使用")]),t._v(" "),a("li",[t._v("記憶體碎片可能會一直沒有機會再使用到，稱為Zombie Memory(殭屍內存)")])]),t._v(" "),a("h2",{attrs:{id:"記憶體管理方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#記憶體管理方法"}},[t._v("#")]),t._v(" 記憶體管理方法")]),t._v(" "),a("ul",[a("li",[t._v("Don't Null it, but Destroy it")]),t._v(" "),a("li",[t._v("Class VS Struct")]),t._v(" "),a("li",[t._v("Pool In Pool（池中池）\n"),a("ul",[a("li",[t._v("VM 本身有内存池，但建議開發者對高頻率使用的物件，建内存池。例如子彈等。")])])]),t._v(" "),a("li",[t._v("Closures and anonymous methods（閉包和匿名函數）\n"),a("ul",[a("li",[t._v("如果看 IL，所有匿名函數和閉包會 new 成一個 匿名class，因此所有變量和要 new 的東西都是要占記憶體的。而且會導致協程。\n"),a("ul",[a("li",[t._v("有些開發者會在遊戲開始啟用一個協程，直到遊戲结束才釋放，這是錯誤的。")]),t._v(" "),a("li",[t._v("只要協程不被釋放掉，所有變量都會一直占用記憶體。")])])])])]),t._v(" "),a("li",[t._v("Coroutines（協程）\n"),a("ul",[a("li",[t._v("可看做閉包和匿名函數的一個特例")]),t._v(" "),a("li",[t._v("最佳實踐：用的時候產生，不用的時候 destroy 掉。")])])]),t._v(" "),a("li",[t._v("Configurations（配置表）\n"),a("ul",[a("li",[t._v("不要把整個配置表都放進去，是否能通過一些方法切分配置表")])])]),t._v(" "),a("li",[t._v("Singleton\n"),a("ul",[a("li",[t._v("慎用")]),t._v(" "),a("li",[t._v("遊戲一開始到遊戲結束，一直在記憶體中。")])])])]),t._v(" "),a("h2",{attrs:{id:"曾經被unity詛咒的foreach"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#曾經被unity詛咒的foreach"}},[t._v("#")]),t._v(" 曾經被Unity詛咒的"),a("strong",[t._v("foreach")])]),t._v(" "),a("p",[t._v("之前unity在foreach上有bug會導致產生GC Alloc")]),t._v(" "),a("p",[t._v("原因主要在IL層裡面有一個box裝箱的過程以及IEnumrator中newObject的過程")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("using UnityEngine;\nusing System.Collections;\nusing System.Collections.Generic;\n\npublic class ForeachTestScript : MonoBehaviour {\n    List<int> list = new List<int>();\n    public void Test()\n    {\n        foreach (int current in list)\n        {\n            Debug.Log(current);\n        }\n    }\n}\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("p",[t._v("實際上oreach在編譯的過程會變成以下內容")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("using System;\nusing System.Collections.Generic;\nusing UnityEngine;\n\npublic class ForeachTestScript : MonoBehaviour\n{\n\tprivate List<int> list = new List<int>();\n\n\tpublic void Test()\n\t{\n\t\tusing (List<int>.Enumerator enumerator = this.list.GetEnumerator())\n\t\t{\n\t\t\twhile (enumerator.MoveNext())\n\t\t\t{\n\t\t\t\tint current = enumerator.get_Current();\n\t\t\t\tDebug.Log(current);\n\t\t\t}\n\t\t}\n\t}\n}\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br")])]),a("p",[t._v("使用迭代器並且透過while迴圈")]),t._v(" "),a("p",[t._v("這時候一定很好奇:看起來很正常阿怎麼會有GC的問題?")]),t._v(" "),a("p",[t._v("這時候就要往下看IL了")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v(".class public auto ansi beforefieldinit ForeachTestScript\n\textends [UnityEngine]UnityEngine.MonoBehaviour\n{\n\t// 成員\n\t.field private class [mscorlib]System.Collections.Generic.List`1<int32> list\n\n\t// 方法\n\t.method public hidebysig specialname rtspecialname \n\t\tinstance void .ctor () cil managed \n\t{\n\t\t// 方法起始 RVA 地址 0x20ec\n\t\t// 方法起始地址（相對於文件絕對值：0x02ec）\n\t\t// 代碼長度 18 (0x12)\n\t\t.maxstack 8\n\n\t\t// 0x02ED: 02\n\t\tIL_0000: ldarg.0\n\t\t// 0x02EE: 73 01 00 00 0A\n\t\tIL_0001: newobj instance void class [mscorlib]System.Collections.Generic.List`1<int32>::.ctor()\n\t\t// 0x02F3: 7D 01 00 00 04\n\t\tIL_0006: stfld class [mscorlib]System.Collections.Generic.List`1<int32> ForeachTestScript::list\n\t\t// 0x02F8: 02\n\t\tIL_000b: ldarg.0\n\t\t// 0x02F9: 28 02 00 00 0A\n\t\tIL_000c: call instance void [UnityEngine]UnityEngine.MonoBehaviour::.ctor()\n\t\t// 0x02FE: 2A\n\t\tIL_0011: ret\n\t} // 方法 ForeachTestScript::.ctor 结束\n\n\t.method public hidebysig \n\t\tinstance void Test () cil managed \n\t{\n\t\t// 方法起始 RVA 地址 0x2100\n\t\t// 方法起始地址（相對於文件絕對值：0x0300）\n\t\t// 代碼長度 66 (0x42)\n\t\t.maxstack 9\n\t\t.locals init (\n\t\t\t[0] int32,\n\t\t\t[1] valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator<int32>\n\t\t)\n\n\t\t// 0x030C: 02\n\t\tIL_0000: ldarg.0\n\t\t// 0x030D: 7B 01 00 00 04\n\t\tIL_0001: ldfld class [mscorlib]System.Collections.Generic.List`1<int32> ForeachTestScript::list\n\t\t// 0x0312: 6F 03 00 00 0A\n\t\tIL_0006: callvirt instance valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator<!0> class [mscorlib]System.Collections.Generic.List`1<int32>::GetEnumerator()\n\t\t// 0x0317: 0B\n\t\tIL_000b: stloc.1\n\t\t.try\n\t\t{\n\t\t\t// 0x0318: 38 13 00 00 00\n\t\t\tIL_000c: br IL_0024\n\t\t\t// 循环开始 (head: IL_0024)\n\t\t\t\t// 0x031D: 12 01\n\t\t\t\tIL_0011: ldloca.s 1\n\t\t\t\t// 0x031F: 28 04 00 00 0A\n\t\t\t\tIL_0013: call instance !0 valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator<int32>::get_Current()\n\t\t\t\t// 0x0324: 0A\n\t\t\t\tIL_0018: stloc.0\n\t\t\t\t// 0x0325: 06\n\t\t\t\tIL_0019: ldloc.0\n\t\t\t\t// 0x0326: 8C 04 00 00 01\n\t\t\t\tIL_001a: box [mscorlib]System.Int32\n\t\t\t\t// 0x032B: 28 05 00 00 0A\n\t\t\t\tIL_001f: call void [UnityEngine]UnityEngine.Debug::Log(object)\n\n\t\t\t\t// 0x0330: 12 01\n\t\t\t\tIL_0024: ldloca.s 1\n\t\t\t\t// 0x0332: 28 06 00 00 0A\n\t\t\t\tIL_0026: call instance bool valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator<int32>::MoveNext()\n\t\t\t\t// 0x0337: 3A E1 FF FF FF\n\t\t\t\tIL_002b: brtrue IL_0011\n\t\t\t// 循還结束\n\n\t\t\t// 0x033C: DD 0C 00 00 00\n\t\t\tIL_0030: leave IL_0041\n\t\t} // .try 结束\n\t\tfinally\n\t\t{\n\t\t\t// 0x0341: 07\n\t\t\tIL_0035: ldloc.1\n\t\t\t// 0x0342: 8C 02 00 00 1B\n\t\t\tIL_0036: box valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator<int32>\n\t\t\t// 0x0347: 6F 07 00 00 0A\n\t\t\tIL_003b: callvirt instance void [mscorlib]System.IDisposable::Dispose()\n\t\t\t// 0x034C: DC\n\t\t\tIL_0040: endfinally\n\t\t} // 捕捉结束\n\n\t\t// 0x034D: 2A\n\t\tIL_0041: ret\n\t} // 方法 ForeachTestScript::Test 结束\n\n} // 類別 ForeachTestScript 结束\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br"),a("span",{staticClass:"line-number"},[t._v("27")]),a("br"),a("span",{staticClass:"line-number"},[t._v("28")]),a("br"),a("span",{staticClass:"line-number"},[t._v("29")]),a("br"),a("span",{staticClass:"line-number"},[t._v("30")]),a("br"),a("span",{staticClass:"line-number"},[t._v("31")]),a("br"),a("span",{staticClass:"line-number"},[t._v("32")]),a("br"),a("span",{staticClass:"line-number"},[t._v("33")]),a("br"),a("span",{staticClass:"line-number"},[t._v("34")]),a("br"),a("span",{staticClass:"line-number"},[t._v("35")]),a("br"),a("span",{staticClass:"line-number"},[t._v("36")]),a("br"),a("span",{staticClass:"line-number"},[t._v("37")]),a("br"),a("span",{staticClass:"line-number"},[t._v("38")]),a("br"),a("span",{staticClass:"line-number"},[t._v("39")]),a("br"),a("span",{staticClass:"line-number"},[t._v("40")]),a("br"),a("span",{staticClass:"line-number"},[t._v("41")]),a("br"),a("span",{staticClass:"line-number"},[t._v("42")]),a("br"),a("span",{staticClass:"line-number"},[t._v("43")]),a("br"),a("span",{staticClass:"line-number"},[t._v("44")]),a("br"),a("span",{staticClass:"line-number"},[t._v("45")]),a("br"),a("span",{staticClass:"line-number"},[t._v("46")]),a("br"),a("span",{staticClass:"line-number"},[t._v("47")]),a("br"),a("span",{staticClass:"line-number"},[t._v("48")]),a("br"),a("span",{staticClass:"line-number"},[t._v("49")]),a("br"),a("span",{staticClass:"line-number"},[t._v("50")]),a("br"),a("span",{staticClass:"line-number"},[t._v("51")]),a("br"),a("span",{staticClass:"line-number"},[t._v("52")]),a("br"),a("span",{staticClass:"line-number"},[t._v("53")]),a("br"),a("span",{staticClass:"line-number"},[t._v("54")]),a("br"),a("span",{staticClass:"line-number"},[t._v("55")]),a("br"),a("span",{staticClass:"line-number"},[t._v("56")]),a("br"),a("span",{staticClass:"line-number"},[t._v("57")]),a("br"),a("span",{staticClass:"line-number"},[t._v("58")]),a("br"),a("span",{staticClass:"line-number"},[t._v("59")]),a("br"),a("span",{staticClass:"line-number"},[t._v("60")]),a("br"),a("span",{staticClass:"line-number"},[t._v("61")]),a("br"),a("span",{staticClass:"line-number"},[t._v("62")]),a("br"),a("span",{staticClass:"line-number"},[t._v("63")]),a("br"),a("span",{staticClass:"line-number"},[t._v("64")]),a("br"),a("span",{staticClass:"line-number"},[t._v("65")]),a("br"),a("span",{staticClass:"line-number"},[t._v("66")]),a("br"),a("span",{staticClass:"line-number"},[t._v("67")]),a("br"),a("span",{staticClass:"line-number"},[t._v("68")]),a("br"),a("span",{staticClass:"line-number"},[t._v("69")]),a("br"),a("span",{staticClass:"line-number"},[t._v("70")]),a("br"),a("span",{staticClass:"line-number"},[t._v("71")]),a("br"),a("span",{staticClass:"line-number"},[t._v("72")]),a("br"),a("span",{staticClass:"line-number"},[t._v("73")]),a("br"),a("span",{staticClass:"line-number"},[t._v("74")]),a("br"),a("span",{staticClass:"line-number"},[t._v("75")]),a("br"),a("span",{staticClass:"line-number"},[t._v("76")]),a("br"),a("span",{staticClass:"line-number"},[t._v("77")]),a("br"),a("span",{staticClass:"line-number"},[t._v("78")]),a("br"),a("span",{staticClass:"line-number"},[t._v("79")]),a("br"),a("span",{staticClass:"line-number"},[t._v("80")]),a("br"),a("span",{staticClass:"line-number"},[t._v("81")]),a("br"),a("span",{staticClass:"line-number"},[t._v("82")]),a("br"),a("span",{staticClass:"line-number"},[t._v("83")]),a("br"),a("span",{staticClass:"line-number"},[t._v("84")]),a("br"),a("span",{staticClass:"line-number"},[t._v("85")]),a("br"),a("span",{staticClass:"line-number"},[t._v("86")]),a("br"),a("span",{staticClass:"line-number"},[t._v("87")]),a("br"),a("span",{staticClass:"line-number"},[t._v("88")]),a("br"),a("span",{staticClass:"line-number"},[t._v("89")]),a("br"),a("span",{staticClass:"line-number"},[t._v("90")]),a("br"),a("span",{staticClass:"line-number"},[t._v("91")]),a("br"),a("span",{staticClass:"line-number"},[t._v("92")]),a("br"),a("span",{staticClass:"line-number"},[t._v("93")]),a("br"),a("span",{staticClass:"line-number"},[t._v("94")]),a("br"),a("span",{staticClass:"line-number"},[t._v("95")]),a("br")])]),a("p",[t._v("finally裡面")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("IL_0036: box valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator<int32>\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("box valuetype：裝箱，將值類型封裝成valTypeToken指定的對像類型")]),t._v(" "),a("p",[t._v("過程:")]),t._v(" "),a("ul",[a("li",[t._v("彈出計算堆棧上的值類型參數")]),t._v(" "),a("li",[t._v("使用新建立的引用類型對象進行並包裝")]),t._v(" "),a("li",[t._v("將包裝結果返回計算堆棧")])]),t._v(" "),a("p",[t._v("以上過程將產生GC Alloc。")]),t._v(" "),a("blockquote",[a("p",[a("strong",[t._v("問:那現在還有這個問題嗎?")])])]),t._v(" "),a("blockquote",[a("p",[a("strong",[t._v("答:當然沒有，unity以在5.3版本修復此問題")])])]),t._v(" "),a("p",[t._v("以下連結是網友測試結果:")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.codenong.com/cs105329519/",target:"_blank",rel:"noopener noreferrer"}},[t._v("對C#在unity編譯環境下foreach關鍵字GC的測試"),a("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=e.exports}}]);